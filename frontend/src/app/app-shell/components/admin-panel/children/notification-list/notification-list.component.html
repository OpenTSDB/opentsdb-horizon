<div class="top-actions">
    <button mat-flat-button color="primary" (click)="createNotification()">
        <span>Create Notification</span>
    </button>
</div>

<div class="notifications-wrapper">
    <mat-accordion class="notifications">
        <!-- ACTIVE NOTIFICATION AT TOP -->
        <mat-expansion-panel *ngIf="active"
            [expanded]="panelExpanded === 'active'"
            (opened)="expandPanel('active')"
            class="active-notification"
            [ngClass]="{
                'waiting-block': (deleteConfirm !== -1 && deleteConfirm !== active.id),
                'delete-confirm': deleteConfirm === active.id,
                'info-notification-type': active.settings.notification.type === 'info',
                'alert-notification-type': active.settings.notification.type === 'alert'
            }">
            <mat-expansion-panel-header collapsedHeight="48px" expandedHeight="48px">
                <mat-panel-title>
                    <div class="type {{active.settings.notification.type}}-type" >
                        <mat-icon fontSet="denali" [fontIcon]="active.settings.notification.type === 'info'? 'd-information-circle' : 'd-notification-priority'"></mat-icon>
                    </div>
                    <div class="active">
                        <span>active</span>
                    </div>
                </mat-panel-title>
                <mat-panel-description>
                    <div class="title">{{active.settings.title}}</div>
                    <span class="updated">last updated: {{active.settings.notification.updatedTime | date:'shortDate'}} by {{active.settings.notification.updatedBy.replace('user.','')}}</span>
                </mat-panel-description>
            </mat-expansion-panel-header>
            <ng-container *ngTemplateOutlet="notificationPreviewOutput;context:{notification: active}"></ng-container>
            <mat-action-row>
                <button mat-flat-button color="primary" (click)="disableNotification(active, 'active')">Disable</button>
                <span class="flex-spacer"></span>
                <button mat-stroked-button color="primary" (click)="editNotification(active, 'active')">Edit</button>
                <ng-container *ngIf="deleteConfirm === active.id">
                    <ng-container *ngTemplateOutlet="deleteConfirmationModal;context:{notification: active, i: 'active'}"></ng-container>
                </ng-container>
            </mat-action-row>
        </mat-expansion-panel>

        <!-- LIST OF OTHER (DISABLED) NOTIFICATIONS -->
        <ng-container *ngFor="let notification of notifications; let i = index;">
            <mat-expansion-panel *ngIf="!notification.settings.notification.enabled"
                [expanded]="panelExpanded === i"
                (opened)="expandPanel(i)"
                [ngClass]="{
                    'waiting-block': (deleteConfirm !== -1 && deleteConfirm !== notification.id),
                    'delete-confirm': deleteConfirm === notification.id,
                    'info-notification-type': notification.settings.notification.type === 'info',
                    'alert-notification-type': notification.settings.notification.type === 'alert'
                }">
                <mat-expansion-panel-header collapsedHeight="48px" expandedHeight="48px">
                    <mat-panel-title>
                        <div class="type {{notification.settings.notification.type}}-type">
                            <mat-icon fontSet="denali" [fontIcon]="notification.settings.notification.type === 'info'? 'd-information-circle' : 'd-notification-priority'"></mat-icon>
                        </div>
                        <div class="disabled">
                            <span>disabled</span>
                        </div>
                    </mat-panel-title>
                    <mat-panel-description>
                        <div class="title">{{notification.settings.title}}</div>
                        <span class="updated">last updated: {{notification.settings.notification.updatedTime | date:'shortDate'}} by {{notification.settings.notification.updatedBy.replace('user.','')}}</span>
                    </mat-panel-description>
                </mat-expansion-panel-header>
                <ng-container *ngTemplateOutlet="notificationPreviewOutput;context:{notification: notification}"></ng-container>
                <mat-action-row>
                    <button mat-flat-button color="primary"
                        (click)="enableNotification(notification, i)">Enable</button>
                    <span class="flex-spacer"></span>
                    <button mat-stroked-button color="primary" (click)="editNotification(notification, i)">Edit</button>
                    <button mat-stroked-button color="primary" (click)="deleteNotification(notification, i)">Delete</button>
                    <ng-container *ngIf="deleteConfirm === notification.id">
                        <ng-container *ngTemplateOutlet="deleteConfirmationModal;context:{notification: notification, i: i}"></ng-container>
                    </ng-container>
                </mat-action-row>
            </mat-expansion-panel>
        </ng-container>

    </mat-accordion>
</div>

<ng-template #notificationPreviewOutput let-notification="notification">
    <div class="notification-preview">
        <div class="summary-content">
            <strong>Summary:</strong>&nbsp;{{notification.settings.summary}}
        </div>
        <hr style="margin: 8px 0;"/>
        <div class="detail-content">
            <markdown class="markdown-body" id="markdown-override"
                [data]="notification.settings.visual.text"></markdown>
        </div>
    </div>
</ng-template>

<ng-template #deleteConfirmationModal let-notification="notification" let-i="i">
    <div class="delete-confirm-actions" *ngIf="deleteConfirm === notification.id">
        <div class="delete-confirm-actions-wrapper">
            <div class="confirmation-message">Are you <strong>sure</strong> you want to delete this notification?</div>
            <div class="confirmation-actions">
                <button mat-flat-button color="primary" (click)="deleteNotification(notification, i)">Yes</button>
                <button mat-stroked-button color="primary" (click)="cancelDeletion()">No</button>
            </div>
        </div>
    </div>
</ng-template>
