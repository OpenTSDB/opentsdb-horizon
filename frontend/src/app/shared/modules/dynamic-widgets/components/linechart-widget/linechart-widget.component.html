<div class="widget-output-container" #widgetOutputContainer fxLayout="column">
    <div class="widget-output" #widgetoutput
        [ngClass]="{
            'multigraph-enabled': multigraphEnabled,
            'singlegraph-enabled': !multigraphEnabled,
            'display-legend-top': widget.settings.legend.display && widget.settings.legend.position=='top' && options.labels.length > 1,
            'display-legend-right': widget.settings.legend.display && widget.settings.legend.position=='right' && options.labels.length > 1,
            'display-legend-bottom': widget.settings.legend.display && widget.settings.legend.position=='bottom' && options.labels.length > 1,
            'display-legend-left': widget.settings.legend.display && widget.settings.legend.position=='left' && options.labels.length > 1
        }">
        <div class="dygraph-legend" #graphLegend></div>
        <!-- STANDARD GRAPH OUTPUT -->
        <div class="multigraph-output" (scroll)="multigraphContainerScroll($event)">
            <div class="multi-graph-container" #multigraphContainer
                [ngClass]="{'multigraph-grid-mode': multigraphMode === 'grid', 'multigraph-freeflow-mode': multigraphMode === 'freeflow'}"
                [style.minWidth.px]="(multigraphEnabled && multigraphMode === 'grid') ? ((size.width * multigraphColumns.length) - 6) : 'initial'">
                <!-- column headers -->
                <div class="graph-header-row" #multigraphHeaderRow *ngIf="multigraphColumns.length > 0 && multigraphMode === 'grid'">
                    <div class="graph-header-cell" *ngFor="let columnName of multigraphColumns" [style.width.px]="size.width">
                        <div class="graph-header-cell-inner">
                            <span>{{columnName}}</span>
                        </div>
                    </div>
                </div>
                <!-- graphs -->
                <ng-container *ngFor="let yKey of getGraphDataObjectKeys(graphData); let i = index;">
                    <!-- row labels-->
                    <ng-container *ngIf="multigraphEnabled && multigraphMode === 'grid' && yKey !== 'y'">
                        <div class="graph-row-label">
                            <div class="graph-row-label-inner" [style.marginLeft.px]="graphRowLabelMarginLeft">
                                <span>{{yKey}}</span>
                            </div>
                        </div>
                    </ng-container>
                    <div class="graph-row">
                        <!-- graph loop -->
                        <ng-container *ngFor="let xKey of getGraphDataObjectKeys(graphData[yKey]); let j = index;">
                            <div class="graph-cell graph-cell-{{i}}-{{j}}"
                                [ngClass]="{'ts-legend-focus': (!multigraphEnabled) ? legendFocus : (legendFocus && (legendFocus.y === yKey && legendFocus.x === xKey))}"
                                [style.width.px]="(!multigraphEnabled) ? size.width + legendWidth : size.width"
                                [style.height.px]="(!multigraphEnabled) ? size.height + legendHeight : (multigraphEnabled && multigraphMode === 'freeflow') ? size.height + 15 : size.height"
                                [style.maxWidth]="(multigraphEnabled && multigraphMode === 'freeflow') ? size.width + 'px' : 'initial'">
                                <div class="graph-header" *ngIf="multigraphEnabled && multigraphMode === 'freeflow'">
                                    <div class="graph-header-inner">
                                        <span>{{(yKey !== 'y') ? yKey + ': ' : ''}}{{xKey}}</span>
                                    </div>
                                </div>
                                <div class="no-data" *ngIf="graphData[yKey][xKey].ts.length === 0" [style.minWidth.px]="size.width">
                                    <span>No Data Available</span>
                                </div>
                                <div #graphdiv id="{{yKey}}|{{xKey}}" *ngIf="graphData[yKey][xKey].ts.length > 0">
                                    <div #dygraph class="graph-chart" *ngIf="(inViewport[yKey] !== undefined && inViewport[yKey][xKey] === true) || !multigraphEnabled"
                                        [ngClass]="{'hide': widget.settings.legend.display &&  ( size.width <= 10 || size.height <= 10 ) }"
                                        dygraphsChart
                                        [chartType]="chartType"
                                        [data]="graphData[yKey][xKey]"
                                        [size]="{'width':(size.width - 6), 'height': (size.height - 6)}"
                                        [options]="multigraphEnabled ? graphData[yKey][xKey].options : options"
                                        [eventBuckets]="buckets"
                                        [showEvents]="widget.settings.visual.showEvents"
                                        [multigraph]="multigraphEnabled"
                                        [timeseriesLegend]="tsLegendOptions"
                                        (currentTickEvent)="timeseriesTickListener(i, j, yKey, xKey, $event)"
                                        (dateWindow)="receivedDateWindow($event)"
                                        (zoomed)="handleZoom($event)">
                                    </div>
                                    <!--<div class="dygraph-legend" #graphLegend [attr.id]="'graphlegend-' + i + '-' + j"></div>-->
                                    <div class="events-overlay" [hidden]="!widget.settings.visual.showEvents" *ngIf="!multigraphEnabled"
                                        [ngStyle]="axisEnabled(options.series).has('y') && {'padding-left': '50px'}">
                                        <event-timeline
                                        [startTime]="startTime"
                                        [endTime]="endTime"
                                        [width]="eventsWidth"
                                        [events]="events"
                                        [toolTipHeightFromTop]="size.height"
                                        [timezone] = "options.labelsUTC ? 'utc' : 'local'"
                                        (canvasClicked)="updatedShowEventStream(true)"
                                        (bucketClicked)="bucketClickedAtIndex($event)"
                                        (newBuckets)="newBuckets($event)"></event-timeline>
                                    </div>
                                </div>

                                <div class="graph-legend"
                                    [style.minWidth]="legendWidth"
                                    [style.height]="legendHeight"
                                    [style.flex]="(widget.settings.legend.display && (widget.settings.legend.position=='top' || widget.settings.legend.position=='bottom')) ? '1 1 ' + legendHeight : '1 1 ' + legendWidth"
                                    *ngIf="!multigraphEnabled">
                                    <ng-container *ngIf="widget.settings.legend.display">
                                        <table mat-table matSort [dataSource]="legendDataSource">
                                            <ng-container matColumnDef="color">
                                                    <th mat-header-cell *matHeaderCellDef></th>
                                                    <td mat-cell *matCellDef="let element"><div class="line-series"  [style.backgroundColor]= "element.color"></div></td>
                                            </ng-container>
                                            <ng-container matColumnDef="name">
                                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>name</th>
                                                    <td mat-cell class="nowrap" *matCellDef="let element" [style.textDecoration]="options.visibility[element.srcIndex-1]===true? 'none': 'line-through'" > {{element.name}} </td>
                                            </ng-container>
                                            <ng-container *ngFor="let column of widget.settings.legend.columns || [] " [matColumnDef]="column">
                                                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ column }}</th>
                                                <td mat-cell class="nowrap" *matCellDef="let element"> {{ normalizeValue(element[column], element.srcIndex) }}</td>
                                            </ng-container>
                                            <ng-container >
                                                <tr mat-header-row *matHeaderRowDef="legendDisplayColumns;sticky: true"></tr>
                                            </ng-container>
                                            <tr mat-row *matRowDef="let element; columns: legendDisplayColumns" (click)="toggleChartSeries(element.srcIndex-1, false)" (dblclick)="toggleChartSeries(element.srcIndex-1, true)"></tr>
                                        </table>
                                    </ng-container>
                                </div>
                            </div>
                            <div class="freeflow-break" *ngIf="multigraphMode === 'freeflow' && (((j + 1) / freeflowBreak) % 1 === 0)"></div>
                        </ng-container>
                    </div>
                </ng-container>
            </div>
        </div>

        <!--<div class="loading-spinner size-s color-primary" *ngIf="nQueryDataLoading > 0"></div>-->
        <div class="gif-spinner" *ngIf="nQueryDataLoading > 0">
            <img src="/assets/spinner-26x26.gif" />
        </div>
        <div class="error" *ngIf="error" (click)="showError()">
            <mat-icon>error</mat-icon>
        </div>
        <div class="debug" *ngIf="debugData" (click)="showDebug()">
            <mat-icon>info</mat-icon> {{ this.widget.id }}
        </div>
    </div>
</div>

<!-- NOTE: This needs to move to other component -->
<div class="widget-controls-container" *ngIf="editMode">
    <div class="widget-title">
        <span fxFlex="1 1 100%">
            <inline-editable class="navbar-item" 
            [fieldValue]="widget.settings.title"
            [minLength]="3"
            [maxLength]="100"
            (updatedValue)="setTitle($event)">
        </inline-editable>
        </span>
        <graph-type (change)="changeWidgetType($event)" selected="LinechartWidgetComponent"></graph-type>
    </div>
    <!-- tabs with config content -->
    <mat-tab-group class="widget-configs" color="primary" [@.disabled]="'true'">
        <mat-tab label="Queries" class="test">
            <!-- ng-template is to lazy-load tab content (see: https://material.angular.io/components/tabs/overview#lazy-loading ) -->
            <ng-template matTabContent>
                <widget-config-metric-queries [options]="{enableMultipleQueries: true}" [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-metric-queries>
            </ng-template>
        </mat-tab>
        <mat-tab label="Time Configuration" [disabled]="editQueryId">
            <ng-template matTabContent>
                <widget-config-time [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-time>
            </ng-template>
        </mat-tab>
        <mat-tab label="Axes" [disabled]="editQueryId">
            <ng-template matTabContent>
                <widget-config-axes [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-axes>
            </ng-template>
        </mat-tab>
        <mat-tab label="Visual Appearance" [disabled]="editQueryId">
            <ng-template matTabContent>
                <widget-config-visual-appearance [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-visual-appearance>
            </ng-template>
        </mat-tab>
        <mat-tab label="Legend" [disabled]="editQueryId">
                <ng-template matTabContent>
                    <widget-config-legend *ngIf="!multigraphEnabled" [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-legend>
                    <div *ngIf="multigraphEnabled" class="disabled-message">
                        Legend <b>disabled</b> with multiple graphs.
                    </div>
                </ng-template>
        </mat-tab>
        <mat-tab label="Multigraph [Beta]" [disabled]="editQueryId">
                <ng-template matTabContent>
                    <widget-config-multigraph [isDataLoaded]= "isDataLoaded" [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-multigraph>
                </ng-template>
        </mat-tab>
        <mat-tab label="Meta Data" [disabled]="editQueryId">
                <ng-template matTabContent>
                    <widget-config-general [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-general>
                </ng-template>
        </mat-tab>
        <mat-tab label="Events" class="events" [disabled]="editQueryId">
                <ng-template matTabContent>
                    <div class="events-config" *ngIf="!multigraphEnabled">
                        <widget-config-events [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-events>
                        <div *ngIf="widget.settings.visual.showEvents" class="event-result-title"> Preview </div>
                        <event-list *ngIf="widget.settings.visual.showEvents" class="events-list" [events]="events" [timezone]="timezone" [startTime]="startTime" [endTime]="endTime" [previewLimit]="previewEventsCount" [loading]="eventsLoading" [error]="eventsError">
                        </event-list>
                    </div>

                    <div *ngIf="multigraphEnabled" class="disabled-message">
                        Events <b>disabled</b> with multiple graphs.
                    </div>
                </ng-template>
        </mat-tab>
        <mat-tab>
            <!-- custom tab label. (see: https://material.angular.io/components/tabs/overview#labels) -->
            <!-- <ng-template mat-tab-label>
                &lt;/&gt; Query Editor
            </ng-template> -->
            <ng-template matTabContent>
                <widget-config-query-inspector [widget]="widget"></widget-config-query-inspector>
            </ng-template>
        </mat-tab>
    </mat-tab-group>
    <div class="widget-actions"  *ngIf="!editQueryId">
        <!-- controls to save/cancel -->
        <button mat-raised-button color="primary" class="mat-elevation-z0" (click)="applyConfig()">Apply to Dashboard</button>
        <button mat-stroked-button color="primary" class="mat-elevation-z0" (click)="closeViewEditMode()">Cancel</button>
    </div>
</div>
